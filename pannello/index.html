<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pannello di Controllo - Prenotazioni</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-slate-100">

    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-xl font-bold text-slate-800">Pannello di Controllo</h1>
                <div class="text-sm text-slate-600">Benvenuto, Ristorante "Il Goloso"</div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-slate-900">Prenotazioni in Arrivo</h2>
            <p class="text-slate-600 mt-1">Gestisci le richieste di prenotazione dei tuoi clienti in tempo reale.</p>
        </div>

        <div id="loader" class="text-center py-10">
            <p>Caricamento prenotazioni...</p>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <ul id="booking-list" class="divide-y divide-slate-200">
                <!-- Le prenotazioni da Firebase appariranno qui -->
            </ul>
        </div>
    </main>

    <!-- Importa le librerie di Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqjGiIOLmBKdgWdfIUryQIZuht3iClTpc",
            authDomain: "saas-ristoranti.firebaseapp.com",
            projectId: "saas-ristoranti",
            storageBucket: "saas-ristoranti.firebasestorage.app",
            messagingSenderId: "967466784588",
            appId: "1:967466784588:web:d5b00440aaba806e06e1e9",
            measurementId: "G-0LZ8TRWNR0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // --- Logica della Pagina ---
        const bookingList = document.getElementById('booking-list');
        const loader = document.getElementById('loader');

        function createBookingHtml(booking) {
            let statusBadge;
            let actionButtons;
            switch (booking.status) {
                case 'pending':
                    statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full">In attesa</span>`;
                    actionButtons = `
                        <button data-id="${booking.id}" data-action="confirm" class="confirm-btn bg-green-500 text-white text-sm font-bold py-1 px-3 rounded-lg hover:bg-green-600 transition">Conferma</button>
                        <button data-id="${booking.id}" data-action="cancel" class="cancel-btn bg-red-500 text-white text-sm font-bold py-1 px-3 rounded-lg hover:bg-red-600 transition ml-2">Cancella</button>
                    `;
                    break;
                case 'confirmed':
                    statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">Confermata</span>`;
                    actionButtons = `<button data-id="${booking.id}" data-action="cancel" class="cancel-btn bg-slate-400 text-white text-sm font-bold py-1 px-3 rounded-lg hover:bg-slate-500 transition ml-2">Annulla</button>`;
                    break;
                case 'cancelled':
                    statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">Cancellata</span>`;
                    actionButtons = ``;
                    break;
            }
            return `
                <li class="p-4 sm:p-6 hover:bg-slate-50 transition">
                    <div class="flex items-center justify-between flex-wrap">
                        <div class="w-full sm:w-auto mb-4 sm:mb-0">
                            <p class="font-bold text-lg text-slate-800">${booking.name}</p>
                            <p class="text-slate-600 text-sm">
                                ${booking.people} persone &bull; ${new Date(booking.date).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })} alle ${booking.time}
                            </p>
                        </div>
                        <div class="flex items-center">
                            <div class="mr-4">${statusBadge}</div>
                            <div>${actionButtons}</div>
                        </div>
                    </div>
                </li>`;
        }
        
        const bookingsCol = collection(db, 'bookings');
        onSnapshot(bookingsCol, (snapshot) => {
            loader.style.display = 'none';
            let bookings = [];
            snapshot.docs.forEach((doc) => {
                bookings.push({ ...doc.data(), id: doc.id });
            });
            
            bookingList.innerHTML = '';
            const sortedBookings = bookings.sort((a, b) => {
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                const dateA = a.createdAt?.seconds || 0;
                const dateB = b.createdAt?.seconds || 0;
                return dateB - dateA;
            });
            sortedBookings.forEach(booking => {
                bookingList.innerHTML += createBookingHtml(booking);
            });
        });

        bookingList.addEventListener('click', async function(event) {
            const target = event.target;
            const bookingId = target.dataset.id;
            const action = target.dataset.action;

            if (!bookingId || !action) return;

            const bookingRef = doc(db, "bookings", bookingId);
            let newStatus = '';

            if (action === 'confirm') newStatus = 'confirmed';
            else if (action === 'cancel') newStatus = 'cancelled';
            
            if (newStatus) {
                try {
                    await updateDoc(bookingRef, { status: newStatus });
                } catch(e) {
                    console.error("Errore nell'aggiornamento: ", e);
                }
            }
        });
    </script>
</body>
</html>
